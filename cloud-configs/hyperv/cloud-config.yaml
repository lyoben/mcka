#cloud-config
#apt_mirror: http://sg.archive.ubuntu.com/ubuntu/

apt:
  # Preserve existing /etc/apt/sources.list
  # Default: overwrite sources_list with mirror.  If this is true
  # then apt_mirror above will have no effect
  preserve_sources_list: false

  sources:
    # Byobu PPA
    byobu-ppa.list:
      source: "deb [arch=amd64 signed-by=$KEY_FILE] http://ppa.launchpad.net/byobu/ppa/ubuntu focal main"
      keyid: A42A415B4677D2D22EB05723CF5E7496F430BBA5
    # Kubernetes
    kubernetes.list:
      source: "deb [signed-by=$KEY_FILE] https://pkgs.k8s.io/core:/stable:/v1.32/deb/ /"
      keyid: DE15B14486CD377B9E876E1A234654DA9A296436
    # Docker-CE
    docker-ce.list:
      source: "deb [arch=amd64 signed-by=$KEY_FILE] https://download.docker.com/linux/ubuntu $RELEASE stable"
      keyid: 9DC858229FC7DD38854AE2D88D81803C0EBFCD88
    # Git PPA
    git.list:
      source: "deb [arch=amd64 signed-by=$KEY_FILE] http://ppa.launchpad.net/git-core/ppa/ubuntu $RELEASE main"
      keyid: F911AB184317630C59970973E363C90F8F1B6217

# Install additional packages on first boot
#
# Default: none
#
# if packages are specified, this apt_update will be set to true
#
packages:
 - apt-transport-https
 - ca-certificates
 - curl
 - software-properties-common
 - jq
 - docker-ce
 - docker-ce-cli
 - containerd.io
 - kubectl=1.32.1-*

# Default: true
# Aliases: apt_update
package_update: true

# Default: false
# Aliases: apt_upgrade
package_upgrade: true

# Reboot after package install/update if necessary
# Default: false
# Aliases: apt_reboot_if_required
package_reboot_if_required: false

# mount_default_fields
# These values are used to fill in any entries in 'mounts' that are not
# complete.  This must be an array, and must have 7 fields.
mount_default_fields: [ None, None, "auto", "defaults,nobootwait", "0", "2" ]

# Add groups to the system
# The following example adds the ubuntu group with members foo and bar and
# the group cloud-users.
groups:
  - student

# Add users to the system. Users are added after groups are added.
users:
  - default
  - name: student
    gecos: student
    primary_group: student
    groups: docker
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    # ssh_authorized_keys:
    #   - ssh-ed25519 XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY

# Enable PasswordAuthentication in /etc/ssh/sshd_config
ssh_pwauth: true

# Set user password
chpasswd:
  expire: false
  users:
    - name: student
      password: student
      type: text

# Enable PasswordAuthentication in /etc/ssh/sshd_config
# ssh_pwauth: true

# manage byobu defaults
# byobu_by_default:
#   'user' or 'enable-user': set byobu 'launch-by-default' for the default user
#   'system' or 'enable-system' or 'enable':
#      enable 'launch-by-default' for all users, do not modify default user
#   'disable': disable both default user and system
#   'disable-system': disable system
#   'disable-user': disable for default user
#   not-set: no changes made
byobu_by_default: enable-system

# disable_root_opts: the value of this variable will prefix the
# respective key in /root/.ssh/authorized_keys if disable_root is true
# see 'man authorized_keys' for more information on what you can do here
#
# The string '$USER' will be replaced with the username of the default user
#
# disable_root_opts: no-port-forwarding,no-agent-forwarding,no-X11-forwarding,command="echo 'Please login as the user \"$USER\" rather than the user \"root\".';echo;sleep 10"

# set the locale to a given locale
# default: en_US.UTF-8
locale: en_SG.UTF-8
# render template default-locale.tmpl to locale_configfile
locale_configfile: /etc/default/locale

# resize_rootfs should the / filesytem be resized on first boot
# this allows you to launch an instance with a larger disk / partition
# and have the instance automatically grow / to accomoddate it
# set to 'False' to disable
# by default, the resizefs is done early in boot, and blocks
# if resize_rootfs is set to 'noblock', then it will be run in parallel
resize_rootfs: True

# final_message
# default: cloud-init boot finished at $TIMESTAMP. Up $UPTIME seconds
# this message is written by cloud-final when the system is finished
# its first boot
final_message: "The system is finally up, after $UPTIME seconds"

# timezone: set the timezone for this instance
# the value of 'timezone' must exist in /usr/share/zoneinfo
timezone: Asia/Singapore

#
# Set NTP
ntp:
  enabled: true
# manual cache clean.
#  By default, the link from /var/lib/cloud/instance to
#  the specific instance in /var/lib/cloud/instances/ is removed on every
#  boot.  The cloud-init code then searches for a DataSource on every boot
#  if your DataSource will not be present on every boot, then you can set
#  this option to 'True', and maintain (remove) that link before the image
#  will be booted as a new instance.
# default is False
# manual_cache_clean: True

# When cloud-init is finished running including having run
# cloud_init_modules, then it will run this command.  The default
# is to emit an upstart signal as shown below.  If the value is a
# list, it will be passed to Popen.  If it is a string, it will be
# invoked through 'sh -c'.
#
# default value:
# cc_ready_cmd: [ initctl, emit, cloud-config, CLOUD_CFG=/var/lib/instance/cloud-config.txt ]
# example:
# cc_ready_cmd: [ sh, -c, 'echo HI MOM > /tmp/file' ]

## configure interaction with ssh server
# ssh_svcname: ssh
#    set the name of the option to 'service restart'
#    in order to restart the ssh daemon. For fedora, use 'sshd'
#    default: ssh
ssh_deletekeys: True
#    boolean indicating if existing ssh keys should be deleted on a
#    per-instance basis.  On a public image, this should absolutely be set
#    to 'True'
ssh_genkeytypes: [rsa, ecdsa, ed25519]
#    a list of the ssh key types that should be generated
#    These are passed to 'ssh-keygen -t'

## configuration of ssh keys output to console
ssh_fp_console_blacklist: [ed25519]
ssh_key_console_blacklist: [ssh-dss]
#   A list of key types (first token of a /etc/ssh/ssh_key_*.pub file)
#   that should be skipped when outputting key fingerprints and keys
#   to the console respectively.

# This is an example file to automatically configure resolv.conf when the
# instance boots for the first time.
#
# Ensure that your yaml is valid and pass this as user-data when starting
# the instance. Also be sure that your cloud.cfg file includes this
# configuration module in the appropriate section.
#
# manage-resolv-conf: true

# resolv_conf:
#  nameservers: ['8.8.4.4', '8.8.8.8']

# This is the configuration syntax that the write_files module
# will know how to understand. encoding can be given b64 or gzip or (gz+b64).
# The content will be decoded accordingly and then written to the path that is
# provided.

write_files:
- content: |
      #!/usr/bin/env bash

      pushd /tmp
      # kubectl
      curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
      curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl.sha256"
      echo "$(cat kubectl.sha256)  kubectl" | sha256sum --check
      install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
      # kind
      curl -LO "https://kind.sigs.k8s.io/dl/$(curl -L -s https://api.github.com/repos/kubernetes-sigs/kind/releases/latest | \
        jq -Mr '.tag_name')/kind-linux-amd64"
      curl -LO "https://kind.sigs.k8s.io/dl/$(curl -L -s https://api.github.com/repos/kubernetes-sigs/kind/releases/latest | \
        jq -Mr '.tag_name')/kind-linux-amd64.sha256sum"
      echo "$(cat kind-linux-amd64.sha256sum)" | sha256sum --check
      install -o root -g root -m 0755 kind-linux-amd64 /usr/local/bin/kind
      # k9s
      curl -LO "https://github.com/derailed/k9s/releases/download/$(curl -L -s https://api.github.com/repos/derailed/k9s/releases/latest | \
        jq -Mr '.tag_name')/k9s_Linux_amd64.tar.gz"
      curl -LO "https://github.com/derailed/k9s/releases/download/$(curl -L -s https://api.github.com/repos/derailed/k9s/releases/latest | \
        jq -Mr '.tag_name')/checksums.sha256"
      sha256sum --check --ignore-missing checksums.sha256
      tar zxvf k9s_Linux_amd64.tar.gz k9s
      install -o root -g root -m 0755 k9s /usr/local/bin/k9s
      # helm
      VERSION=$(curl -L -s https://api.github.com/repos/helm/helm/releases/latest | jq -Mr '.tag_name')
      curl -LO "https://get.helm.sh/helm-$VERSION-linux-amd64.tar.gz"
      curl -LO "https://get.helm.sh/helm-$VERSION-linux-amd64.tar.gz.sha256sum"
      sha256sum --check helm-$VERSION-linux-amd64.tar.gz.sha256sum
      tar zxvf helm-$VERSION-linux-amd64.tar.gz linux-amd64/helm
      install -o root -g root -m 0755 linux-amd64/helm /usr/local/bin/helm
      # zellij
      curl -LO "https://github.com/zellij-org/zellij/releases/download/$(curl -L -s https://api.github.com/repos/zellij-org/zellij/releases/latest | \
        jq -Mr '.tag_name')/zellij-x86_64-unknown-linux-musl.tar.gz"
      curl -LO "https://github.com/zellij-org/zellij/releases/download/$(curl -L -s https://api.github.com/repos/zellij-org/zellij/releases/latest | \
        jq -Mr '.tag_name')/zellij-x86_64-unknown-linux-musl.sha256sum"
      tar zxvf zellij-x86_64-unknown-linux-musl.tar.gz zellij
      sha256sum --check zellij-x86_64-unknown-linux-musl.sha256sum
      install -o root -g root -m 0755 zellij /usr/local/bin/zellij
      # minikube
      curl -LO https://github.com/kubernetes/minikube/releases/latest/download/minikube-linux-amd64
      curl -LO https://github.com/kubernetes/minikube/releases/latest/download/minikube-linux-amd64.sha256
      echo "$(cat minikube-linux-amd64.sha256)  minikube-linux-amd64" | sha256sum --check
      install -o root -g root -m 0755 minikube-linux-amd64 /usr/local/bin/minikube
      # cmctl
      curl -LO https://github.com/cert-manager/cmctl/releases/latest/download/cmctl_linux_amd64.tar.gz
      curl -LO https://github.com/cert-manager/cmctl/releases/latest/download/checksums.txt
      sha256sum --check --ignore-missing checksums.txt
      tar zxvf cmctl_linux_amd64.tar.gz cmctl
      install -o root -g root -m 0755 cmctl /usr/local/bin/cmctl
      # yq
      curl -LO https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
      curl -LO https://github.com/mikefarah/yq/releases/latest/download/checksums
      echo "$(grep linux checksums | grep amd | grep -v tar | awk '{print $19}')  yq_linux_amd64" | sha256sum --check
      install -o root -g root -m 0755 yq_linux_amd64 /usr/local/bin/yq
      #
      popd
      mkdir -p /home/ubuntu/Projects/kind
      mkdir -p /home/ubuntu/.local/bin
      cat <<EOF | tee -a /home/ubuntu/Projects/kind/bashrc
      #
      alias k=kubectl
      source <(k completion bash)
      complete -o default -F __start_kubectl k
      source <(kind completion bash)
      source <(k9s completion bash)
      alias mk=minikube
      source <(minikube completion bash)
      complete -o default -F __start_kubectl mk
      EOF
      #
      cat <<EOF > /home/ubuntu/Projects/kind/vimrc
      let g:dracula_italic = 0
      packadd! dracula
      syntax enable
      colorscheme dracula
      set nu rnu
      autocmd FileType yaml,yml,sh setlocal ts=2 sts=2 sw=2 et ai
      set pastetoggle=<F10>
      EOF
      #
      mkdir -p /home/ubuntu/.vim/pack/themes/start
      pushd /home/ubuntu/.vim/pack/themes/start
        git clone -n --depth=1 --filter=tree:0 https://github.com/dracula/vim.git dracula
        pushd /home/ubuntu/.vim/pack/themes/start/dracula
          git sparse-checkout set --no-cone after autoload colors docs
          git checkout
          rm -rf .git
        popd
      popd
      #
      cat <<EOF | tee -a /home/ubuntu/Projects/kind/kind.yaml
      kind: Cluster
      apiVersion: kind.x-k8s.io/v1alpha4
      networking:
        disableDefaultCNI: false # disable kindnet
        podSubnet: 192.168.0.0/16 # set to Calico's default subnet
      nodes:
      - role: control-plane
        image: tsanghan/node:v1.32.1@sha256:d9efeddda2a4b4c1b66261298bb52f4932093e215b09135d3f31801ec35474bd
      - role: worker
        image: tsanghan/node:v1.32.1@sha256:d9efeddda2a4b4c1b66261298bb52f4932093e215b09135d3f31801ec35474bd
      - role: worker
        image: tsanghan/node:v1.32.1@sha256:d9efeddda2a4b4c1b66261298bb52f4932093e215b09135d3f31801ec35474bd
      EOF
      #
      cat <<OUTEOF > /home/ubuntu/.local/bin/metallb.sh
      #!/usr/bin/env bash
      helm repo add metallb https://metallb.github.io/metallb
      # helm install metallb metallb/metallb --namespace metallb-system --create-namespace --set loadBalancerClass=metallb
      helm install metallb metallb/metallb --namespace metallb-system --create-namespace
      kubectl wait --namespace metallb-system \\
                   --for=condition=ready pod \\
                   --selector=app.kubernetes.io/name=metallb \\
                   --timeout=120s
      cat <<EOF | kubectl apply -f -
      ---
      apiVersion: metallb.io/v1beta1
      kind: IPAddressPool
      metadata:
        name: default
        namespace: metallb-system
      spec:
        addresses:
        - 10.254.254.248-10.254.254.254

      ---
      apiVersion: metallb.io/v1beta1
      kind: L2Advertisement
      metadata:
        name: default
        namespace: metallb-system
      EOF
      OUTEOF
      #
      cat <<EOF > /home/ubuntu/.local/bin/metrics-server.sh
      #!/usr/bin/env bash
      helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/
      helm install metrics-server metrics-server/metrics-server \\
        --set args={--kubelet-insecure-tls=true}
      kubectl wait --namespace=default \\
                   --for=condition=ready pod \\
                   --selector=app.kubernetes.io/instance=metrics-server \\
                   --timeout=180s
      EOF
      #
      cat <<EOF > /home/ubuntu/.local/bin/ingress-nic.sh
      #!/usr/bin/env bash
      helm repo add nginx-stable https://helm.nginx.com/stable
      helm install main nginx-stable/nginx-ingress \\
        --set controller.watchIngressWithoutClass=true \\
        --set controller.service.externalTrafficPolicy=Cluster \\
        --set controller.ingressClass.name=nginx-oss
      kubectl wait \\
        --namespace=default \\
        --for=condition=ready pod \\
        --selector=app.kubernetes.io/name=nginx-ingress \\
        --timeout=90s
      EOF
      #
      cat <<EOF > /home/ubuntu/.local/bin/ingress-kic.sh
      #!/usr/bin/env bash
      helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
      helm install ingress-nginx ingress-nginx/ingress-nginx \\
        --namespace ingress-nginx \\
        --create-namespace \\
        --set controller.ingressClassResource.name=ingress-nginx
      EOF
      #
      cat <<EOF > /home/ubuntu/.local/bin/cert-manager.sh
      #!/usr/bin/env bash
      helm repo add jetstack https://charts.jetstack.io
      helm install \\
        cert-manager jetstack/cert-manager \\
        --namespace cert-manager \\
        --create-namespace \\
        --set crds.enabled=true \\
        # --set "extraArgs={--enable-gateway-api=true}"
      EOF
      #
      cat <<EOF > /home/ubuntu/Projects/kind/ingress.yaml
      ---
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        annotations:
          nginx.org/rewrites: serviceName=tea rewrite=/;serviceName=coffee rewrite=/
        name: ingress
      spec:
        ingressClassName: nginx-oss
        rules:
        - host: www.kopi-teh.com
          http:
            paths:
            - backend:
                service:
                  name: coffee
                  port:
                    number: 80
              path: /coffee/
              pathType: Prefix
            - backend:
                service:
                  name: tea
                  port:
                    number: 80
              path: /tea/
              pathType: Prefix
      EOF
      #
      cat <<EOF > /home/ubuntu/Projects/kind/ingress-tls.yaml
      ---
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        annotations:
          nginx.org/rewrites: serviceName=tea rewrite=/;serviceName=coffee rewrite=/
        name: ingress-tls
      spec:
        ingressClassName: nginx-oss
        rules:
        - host: www.kopi-teh.com
          http:
            paths:
            - backend:
                service:
                  name: coffee
                  port:
                    number: 80
              path: /coffee/
              pathType: Prefix
            - backend:
                service:
                  name: tea
                  port:
                    number: 80
              path: /tea/
              pathType: Prefix
        tls:
        - hosts:
          - www.kopi-teh.com
          secretName: kopi-teh
      EOF
      #
      cat <<EOF > /home/ubuntu/Projects/kind/san.cnf
      [req]
      distinguished_name = req_distinguished_name
      x509_extensions = v3_req
      prompt = no
      [req_distinguished_name]
      C = SG
      ST = CBD
      L = SuntecCity
      O = F5
      OU = Training
      CN = www.kopi-teh.com
      [v3_req]
      keyUsage = keyEncipherment, dataEncipherment
      extendedKeyUsage = serverAuth
      subjectAltName = @alt_names
      [alt_names]
      DNS.1 = www.kopi-teh.com
      DNS.2 = www.coffee.net
      DNS.3 = www.tea.io
      EOF
      #
      cat <<EOF > /home/ubuntu/Projects/kind/selfsigned-issuer.yaml
      ---
      apiVersion: cert-manager.io/v1
      kind: Issuer
      metadata:
        name: selfsigned-issuer
        namespace: default
      spec:
        selfSigned: {}
      EOF
      #
      cat <<EOF > /home/ubuntu/Projects/kind/ca-certificate.yaml
      ---
      apiVersion: cert-manager.io/v1
      kind: Certificate
      metadata:
        name: my-selfsigned-ca
        namespace: default
      spec:
        isCA: true
        commonName: my-selfsigned-ca
        secretName: root-secret
        privateKey:
          algorithm: ECDSA
          size: 256
        issuerRef:
          name: selfsigned-issuer
          kind: Issuer
          group: cert-manager.io
      EOF
      #
      cat <<EOF > /home/ubuntu/Projects/kind/ca-issuer.yaml
      ---
      apiVersion: cert-manager.io/v1
      kind: Issuer
      metadata:
        name: my-ca-issuer
        namespace: default
      spec:
        ca:
          secretName: root-secret
      EOF

      cat <<EOF > /home/ubuntu/Projects/kind/ca-cluster-issuer.yaml
      ---
      apiVersion: cert-manager.io/v1
      kind: ClusterIssuer
      metadata:
        name: my-ca-cluster-issuer
      spec:
        ca:
          secretName: root-secret
      EOF
      #
      chmod +x /home/ubuntu/.local/bin/*
      #
      cat /home/ubuntu/Projects/kind/bashrc >> /home/ubuntu/.bashrc
      cp /home/ubuntu/Projects/kind/vimrc /home/ubuntu/.vimrc
      #
      chown -R ubuntu:ubuntu /home/ubuntu
  owner: root:root
  path: /usr/local/bin/1-setup.sh
  permissions: "0755"
- content: |
      #!/usr/bin/env bash

      docker network create \
        --driver=bridge \
        --subnet=10.254.254.0/24 \
        --gateway=10.254.254.1 \
        --opt "com.docker.network.bridge.enable_ip_masquerade"="true" \
        --opt "com.docker.network.driver.mtu"="1500" \
        --ipv6 --subnet=fc00:f853:ccd:e793::/64 \
        kind
  owner: root:root
  path: /usr/local/bin/docker-network-kind.sh
  permissions: "0755"


# run commands
# default: none
# runcmd contains a list of either lists or a string
# each item will be executed in order at rc.local like level with
# output to the console
# - if the item is a list, the items will be properly executed as if
#   passed to execve(3) (with the first arg as the command).
# - if the item is a string, it will be simply written to the file and
#   will be interpreted by 'sh'
#
# Note, that the list has to be proper yaml, so you have to escape
# any characters yaml would eat (':' can be problematic)
runcmd:
 - apt-get -y purge nano
 - apt-get -y autoremove
 - /usr/local/bin/docker-network-kind.sh
 - systemctl restart docker.service
 - /usr/local/bin/1-setup.sh
 - usermod -aG docker ubuntu
 - tar -C /home/ubuntu --exclude ".ssh" -cvf - . | tar -C /home/student -xvf -
 - chown -R student:student /home/student


## poweroff or reboot system after finished
# default: none
power_state:
 delay: now
 mode: reboot
 message: Rebooting machine

